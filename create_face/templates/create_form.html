{% block form %}
<div name="create_form" id="create_form"
  class="flex max-w-xxl bg-gray-201 dark:bg-bg-900 shadow-lg rounded-lg flex-col items-center">
  <input type="hidden" id="create_mode" value="{{ mode }}" />
  <input type="hidden" id="change_mode" value="false" />
  <div id="mode-toggle" class="flex gap-4 items-center my-1">
    <div id="create_mode" hx-target="#create_form" hx-get="/create/" hx-swap="outerHTML"
      hx-vals='js:{mode: "create_mode", change_mode: "true", render_mode:"content"}'
      hx-include="#create_mode, #change_mode, #render_mode"
      class="hover:scale-105 transform transition duration-500 {% if mode == " create_mode" %}border-2 shadow-lg
      border-black dark:border-bg-900{% else %}opacity-50{% endif %} rounded-full bg-white flex">
      <figure class="contents-center">
        <img id="brainstorm" class="h-6 w-6" src="../static/images/brainstorm.svg" alt="Brainstorm" />
        <figcaption class="text-sm">Create</figcaption>
      </figure>
    </div>
    <div id="gallery_mode" hx-target="#create_form" hx-get="/create/" hx-swap="outerHTML"
      hx-vals='js:{mode: "gallery_mode", change_mode: "true", render_mode:"content"}'
      hx-include="#create_mode, #change_mode, #render_mode"
      class="hover:scale-105 transform transition duration-500 {% if mode == " gallery_mode" %}border-2 shadow-lg
      border-black{% else %}opacity-50{% endif %} rounded-full bg-white flex">
      <figure class="text-sm">
        <img id="gallery" class="h-6 w-6" src="../static/images/gallery.svg" alt="Gallery" />
        <figcaption>Gallery</figcaption>
      </figure>
    </div>
  </div>

  {% if mode == "create_mode" %}
  <div id="attributes" class="text-center grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 w-full gap-4 gap-x-6 h-full">
    {% for field in form_fields %}
    <div class="form-group relative rounded-xl">
      <label for="{{ field.id }}" class="text-center block text-sm  text-black dark:text-white">
        {{ field.label }}
      </label>
      <select id="{{ field.id }}"
        class="text-center appearance-none bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 w-full px-3  dark:bg-bg-700 dark:border-gray-500 dark:placeholder-gray-100 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500">
        <option disabled selected></option>
        {% for option in field.options %}
        <option>{{ option }}</option>
        {% endfor %}
      </select>
    </div>
    {% endfor %}
  </div>
  <div id="avatar" class="text-center flex flex-col justify-center items-center my-6 max-w-40">
    <div class="flex items-center justify-center w-full">
      <div class="relative">
        <img src="../static/images/empty_profile.png" alt="Empty Avatar" class="mx-auto rounded-2xl shadow-xl" />
        <img id="ball" class="htmx-indicator absolute right-0 top-1/2 transform -translate-y-1/2"
          src="../static/images/bouncing-ball.svg" alt="Loading..." />
      </div>
    </div>


  </div>
  <div id="generate_button" class="flex flex-col md:flex-row items-center justify-center w-full gap-4">
    <button hx-post="/create/" hx-swap="outerHTML" hx-indicator="#ball"
      hx-vals='js:{generate_method: getPipeline(), gender: getGender(), hair_color: getHairColor(), hair_type: getHairType(), hair_length: getHairLength(), skin_color: getSkinColor(), skin_type: getSkinType(), eye_color: getEyeColor(), age: getAge(), ethnicity: getEthnicity()}'
      class="text-white bg-primary-500 hover:bg-primary-600 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-md px-4 py-2 mb-2 dark:bg-primary-600 dark:hover:bg-primary-700 focus:outline-none dark:focus:ring-primary-800">
      Generate Avatar
    </button>
    <button hx-post="" hx-swap="outerHTML" hx-indicator="#ball"
      hx-vals='js:{generate_method: getHuggingface(), gender: getGender(), hair_color: getHairColor(), hair_type: getHairType(), hair_length: getHairLength(), skin_color: getSkinColor(), skin_type: getSkinType(), eye_color: getEyeColor(), age: getAge(), ethnicity: getEthnicity()}'
      class="bg-blue-700 border text-white py-2 px-4 rounded hover:bg-white hover:text-blue-700 transition duration-300">
      Generate with Hugging Face
    </button>
    {% if user.is_authenticated %}
    <button id="save_image_button" hx-target="#generate_button"
      class="text-white bg-primary-500 hover:bg-primary-600 focus:ring-4 focus:ring-primary-300 font-medium rounded-lg text-md px-4 py-2 mb-2 dark:bg-primary-600 dark:hover:bg-primary-700 focus:outline-none dark:focus:ring-primary-800">
      Save Image
      <img id="save" class="ms-2 h-6 w-6" src="../static/images/save-icon.svg" alt="Save..." />
    </button>
    {% else %}
    <button hx-get="/auth/login/" hx-params="none" hx-swap="outerHTML" hx-target="#content"
      class="flex items-center justify-center text-white bg-gray-700 hover:bg-gray-400 focus:ring-4 focus:ring-gray-50 font-medium rounded-lg text-md px-4 py-2 mb-2">
      Login to Save Avatar
    </button>
    {% endif %}
  </div>
  {% endif %}


  {% if mode == "gallery_mode" %}
  <div id="gallery" class="mt-5 flex flex-col items-center justify-center w-full gap-4">
    <div id="avatar_gallery" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
      {% for image in images %}
      <div name="image_{{ image.id }}" id="image_{{ image.id }}"
        class="relative w-full max-w-xs flex items-center justify-center">
        <div class="relative inline-block">
          <div class="swap-face-button" data-image-path="{{ image.image }}">
            <img src="data:image/png;base64,{{ image.image }}" alt="Avatar"
              class="rounded-lg shadow-lg hover:scale-105 transform transition duration-500 w-full max-h-40 object-cover" />
          </div>
          <div hx-post="/create/delete/{{image.id}}/" hx-target="#image_{{ image.id }}" hx-swap="outerHTML"
            class="border-2 bg-white rounded-full absolute w-8 h-8 -top-4 -right-4 flex items-center justify-center">
            <img id="save" src="../static/images/trash-can.svg" alt="Delete" class="w-4 h-4" />
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>
  {% endif %}

</div>



<script>
  function getPipeline() {
    return "pipeline";
  }

  function getHuggingface() {
    return "hugging_face";
  }

  function getGender() {
    return getValueById("gender");
  }

  function getHairColor() {
    return getValueById("hair_color");
  }

  function getHairType() {
    return getValueById("hair_type");
  }

  function getHairLength() {
    return getValueById("hair_length");
  }

  function getSkinColor() {
    return getValueById("skin_color");
  }

  function getSkinType() {
    return getValueById("skin_type");
  }

  function getEthnicity() {
    return getValueById("ethnicity");
  }

  function getEyeColor() {
    return getValueById("eye_color");
  }

  function getAge() {
    return getValueById("age");
  }

  function getBodyType() {
    return getValueById("body_type");
  }

  function getValueById(id) {
    const element = document.getElementById(id);
    return element.value !== element.options[0].value ? element.value : "";
  }

  function attachImageClickListeners() {
    const images = document.querySelectorAll('#swap-face-button');
    images.forEach(function (image) {
      image.addEventListener('click', function () {
        const imagePath = this.getAttribute('data-image-path');

        // Create a form to submit the data
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/swap_face/';

        // Create hidden input to hold the image data
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'image_data';
        input.value = "data:image/png;base64," + imagePath;

        form.appendChild(input);

        // Add the CSRF token to the form
        const csrfToken = document.createElement('input');
        csrfToken.type = 'hidden';
        csrfToken.name = 'csrfmiddlewaretoken';
        csrfToken.value = '{{ csrf_token }}';

        form.appendChild(csrfToken);

        document.body.appendChild(form);
        form.submit();
      });
    });
  }


  // Attach click listeners to the images after swapping the form
  document.body.addEventListener('htmx:afterSwap', function (evt) {
    if (evt.detail.target.id === 'create_form') {
      attachImageClickListeners();
    }
  });

  document.getElementById('save_image_button').addEventListener('click', function () {
    const imagePath = document.getElementById('image_data').value;

    // Create a form to submit the data
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '/create/save_image/';

    // Create hidden input to hold the image data
    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'image_data';
    input.value = imagePath;

    form.appendChild(input);

    // Add the CSRF token to the form
    const csrfToken = document.createElement('input');
    csrfToken.type = 'hidden';
    csrfToken.name = 'csrfmiddlewaretoken';
    csrfToken.value = '{{ csrf_token }}';

    form.appendChild(csrfToken);

    document.body.appendChild(form);
    form.submit();
  });
</script>
{% endblock %}